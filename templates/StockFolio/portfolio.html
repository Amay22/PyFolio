{% extends 'default.html' %}

{% block main %}
  <br>
  <br>
  <br>
  <script>
    var stock_symbols = {{symbols | safe }}
  </script>

  {% load compress %}
  {% load staticfiles %}
  {% compress js %}
    <script src="{{ STATIC_URL }}scripts/coffee/input_validation.coffee" type="text/coffeescript"></script>
  {% endcompress %}


  <form class="form-inline" role="form" method="post" id="find-stock" action="portfolio">
    {% csrf_token %}
    {% for error in errors %}
      {{ error }}<br>
    {% endfor %}

    {% load compress %}
    {% load staticfiles %}
    {% compress js %}
      <script src="{{ STATIC_URL }}scripts/coffee/autocomplete_symbols.coffee" type="text/coffeescript"></script>
    {% endcompress %}
    <div class="form-group">
      <div class="col-sm-8">
        <input type="text" autofocus="true" name="stock" id="input-find-stock" class="form-control" placeholder="Enter stock symbol">
        <input type="hidden" name="which-form" value="find-stock"/>
      </div>
      <div class="btn-group">
        <button type="submit" class="btn btn-primary">Look up</button>
      </div>
    </div>
  </form>

  {% if stock %}
    <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Symbol</th>
        <th>Last price</th>
        <th>Change</th>
        <th>Volume</th>
        <th>Avg. Vol</th>
        <th>Open</th>
        <th>High</th>
        <th>Low</th>
        <th>Previous Close</th>
        <th>52w Range</th>
        <th>Div & Yield</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ stock.Name }}</td>
        <td>{{ stock.Symbol }}</td>
        <td>{{ stock.LastTradePriceOnly }}</td>
        <td style="color: {% if stock.Change|first == '+' %}green{% else %}red{% endif %};">{{ stock.Change }} ({{ stock.PercentChange}})</td>
        <td>{{ stock.Volume }}</td>
        <td>{{ stock.AverageDailyVolume }}</td>
        <td>{{ stock.Open }} </td>
        <td>{{ stock.DaysHigh }}</td>
        <td>{{ stock.DaysLow }}</td>
        <td>{{ stock.PreviousClose }}</td>
        <td>{{ stock.YearRange }}</td>
        <td>{{ stock.DividendShare }} ( {{ stock.DividendYield }} )</td>
      </tr>
    </tbody>
    </table>

    <form method="post" action="portfolio">
      {% csrf_token %}
      <input type="hidden" name="stock-symbol" value="{{ stock.Symbol }}"/>
      <input type="hidden" name="cost-per-share" value="{{ stock.LastTradePriceOnly }}"/>
      <input type="hidden" name="which-form" value="download-historical"/>
      <button type="submit">Download Historical data of {{ stock.Symbol }} </button>
    </form>

    <form method="post" action="portfolio">
      {% csrf_token %}
      <input name="shares" class="number" placeholder="No. of Shares" type="text"/>
      <input type="hidden" name="stock-symbol" value="{{ stock.Symbol }}"/>
      <input type="hidden" name="cost-per-share" value="{{ stock.LastTradePriceOnly }}"/>
      <input type="hidden" name="which-form" value="buy-stock"/>
      <button type="submit">Buy {{ stock.Symbol }} </button>
    </form>

  {% endif %}
  Money Spent:
  Money Earned:
  {% if portfolio %}
    <table name="portfolio-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Symbol</th>
        <th>Shares</th>
        <th>Last price</th>
        <th>Change</th>
        <th>Volume</th>
        <th>Avg. Vol</th>
        <th>Open</th>
        <th>High</th>
        <th>Low</th>
        <th>Previous Close</th>
        <th>52w Range</th>
        <th>Div & Yield</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for stocks in portfolio %}
        <tr>
          <td>{{ stocks.Name }}</td>
          <td>{{ stocks.Symbol }}</td>
          <td>{{ stocks.shares }}</td>
          <td>{{ stocks.LastTradePriceOnly }}</td>
          <td style="color: {% if stocks.Change|first == '+' %}green{% else %}red{% endif %};">{{ stocks.Change }} ({{ stocks.PercentChange}})</td>
          <td>{{ stocks.Volume }}</td>
          <td>{{ stocks.AverageDailyVolume }}</td>
          <td>{{ stocks.Open }} </td>
          <td>{{ stocks.DaysHigh }}</td>
          <td>{{ stocks.DaysLow }}</td>
          <td>{{ stocks.PreviousClose }}</td>
          <td>{{ stocks.YearRange }}</td>
          <td>{{ stocks.DividendShare }} ( {{ stocks.DividendYield }} )</td>
          <td>
           <form method="post" action="portfolio">
            {% csrf_token %}
            <input name="shares" class="number" placeholder="No. of Shares" type="text"/>
            <input type="hidden" name="stock-symbol" value="{{ stock.Symbol }}"/>
            <input type="hidden" name="cost-per-share" value="{{ stock.LastTradePriceOnly }}"/>
            <input type="hidden" name="which-form" value="buy-stock"/>
            <button type="submit">Buy More {{ stocks.Symbol }} </button>
          </form>
         </td>
          <td>
            <form method="post" action="portfolio">
              {% csrf_token %}
              <input name="shares" class="number sell" placeholder="No. of Shares" type="text"/>
              <input type="hidden" name="stock-symbol" value="{{ stocks.Symbol }}"/>
              <input type="hidden" name="cost-per-share" value="{{ stocks.LastTradePriceOnly }}"/>
              <input type="hidden" name="which-form" value="sell-stock"/>
              <button type="submit">Sell {{ stocks.Symbol }} </button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
    </table>

  {% endif %}

  {% if portfolio_rows %}

    <ul class="nav nav-tabs">
      <li class="active"><a href="#1" data-toggle="tab"><h2>Portfolio OHLC and Volume</h2></a></li>
      <li><a href="#2" data-toggle="tab"><h2>PortFolio Value vs. Time</h2></a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active" id="1">
        <div id="portfolio-ohlc"></div>
      </div>
      <div class="tab-pane active" id="2">
        <div id="portfolio-time-val-graph" style="height:400px;min-width:310px"></div>
      </div>
    </div>

    <h2>Portfolio</h2>

    <table id="portfolio-time-val-table">
      <thead>
        <tr>
          <th>Portfolio Value</th>
          <th>Date</th>
          <th>Percent</th>
          <th>Volume</th>
          <th>High</th>
          <th>Low</th>
          <th>Close</th>
        </tr>
      </thead>
      <tbody>
        {% for row in portfolio_rows %}
        <tr>
          <td class="portfolio-table-value">${{ row.Value | floatformat:2 }}</td>
          <td class="portfolio-table-date">{{ row.Date }}</td>
          <td style="color: {% if row.Percent > 0 %}green{% else %}red{% endif %};">
              {% if row.Percent > 0 %}+{% endif %}{{ row.Percent | floatformat:2 }}
          </td>
          <td class="portfolio-table-vol">{{ row.Volume | floatformat }}</td>
          <td class="portfolio-table-high">{{ row.High | floatformat:2 }}</td>
          <td class="portfolio-table-low">{{ row.Low | floatformat:2 }}</td>
          <td class="portfolio-table-close">{{ row.AdjClose | floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% load compress %}
    {% load staticfiles %}
    {% compress js %}
      <script src="{{ STATIC_URL }}scripts/coffee/plot-val-time.coffee" type="text/coffeescript"></script>
      <script src="{{ STATIC_URL }}scripts/coffee/plot-ohlc.coffee" type="text/coffeescript"></script>
    {% endcompress %}
    {% compress css %}
      <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}stylesheets/techan-plot.css" />
    {% endcompress %}
  {% endif %}
{% endblock %}